<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <title>Sortieralgorithmen vergleichen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="compare.css" />
    <style>
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            max-width: 800px;
            margin: 1rem auto;
            align-items: end;
        }
        .options-grid label {
            margin-top: 0;
        }

        /* (Styling für Slider und Span entfernt) */

    </style>
</head>
<body>
<h1>Vergleich von zwei Sortieralgorithmen</h1>

<div class="center">
    <label>Datensatz-Auswahl</label>
    <select id="datasetSelect"></select>

    <div class="options-grid">
        <div>
            <label for="elementCount">Anzahl Elemente (für Datensätze)</label>
            <input type="number" id="elementCount" value="1000" min="100" max="1000000">
        </div>
        <div>
            <label for="vizSpeed">Visualisierungs-Pause (ms)</label>
            <div>
                <input type="number" id="vizSpeed" value="0" min="0" max="1000">
            </div>
        </div>
    </div>
</div>

<div class="grid">
    <div>
        <label>Algorithmus A</label>
        <select id="algoA"></select>
        <iframe id="frameA" title="Algorithmus A Visualisierung"></iframe>
    </div>
    <div>
        <label>Algorithmus B</label>
        <select id="algoB"></select>
        <iframe id="frameB" title="Algorithmus B Visualisierung"></iframe>
    </div>
</div>

<div class="center">
    <button id="compareBtn">Vergleichen</button>
    <p id="status" class="loading" style="display:none;">Sortiere Daten...</p>
</div>

<table id="resultTable" style="display:none">
    <thead>
    <tr>
        <th>Algorithmus</th>
        <th>Laufzeit (ms)</th>
        <th>Steps</th>
        <th>Unsortiertes Array</th>
        <th>Sortiertes Ergebnis</th>
        <th>Worst Case</th>
        <th>Average Case</th>
        <th>Best Case</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    /**
     * Hauptskript für die Seite "Vergleich von zwei Sortieralgorithmen".
     * ...
     */

        // --- Lokaler Speicher für Datensätze ---
    let datasets = {};

    // --- 1️⃣ Lade verfügbare Sortieralgorithmen vom Backend ---
    async function loadAlgorithms() {
        try {
            const res = await fetch('/api/compare/algorithms');
            if (!res.ok) throw new Error(`Fehler beim Laden der Algorithmen: ${res.status} ${res.statusText}`);

            const algos = await res.json();
            const selectA = document.getElementById('algoA');
            const selectB = document.getElementById('algoB');
            selectA.innerHTML = '';
            selectB.innerHTML = '';

            for (const name of algos) {
                const optionA = document.createElement('option');
                optionA.value = name;
                optionA.textContent = name;
                selectA.appendChild(optionA);

                const optionB = document.createElement('option');
                optionB.value = name;
                optionB.textContent = name;
                selectB.appendChild(optionB);
            }

            if (algos.length >= 2) {
                selectA.selectedIndex = 0;
                selectB.selectedIndex = 1;
            } else if (algos.length === 1) {
                selectA.selectedIndex = 0;
                selectB.selectedIndex = 0;
            }
        } catch (err) {
            console.error('Fehler beim Laden der Algorithmen:', err);
        }
    }

    // --- 2️⃣ Lade Datensätze vom Backend ---
    /**
     * loadDatasets()
     * - Validiert die Elementanzahl. Bei Fehlern wird 100 verwendet und ein Alert gezeigt.
     * ...
     */
    async function loadDatasets() {

        // Elementanzahl-Element und Wert holen
        const countInput = document.getElementById('elementCount');
        let elementCount = parseInt(countInput.value, 10); // Wert als Zahl parsen

        // VALIDIERUNG
        const minCount = 100;
        const maxCount = 1000000;

        // Prüfen, ob (NaN - keine Zahl) ODER (unter Min) ODER (über Max)
        if (isNaN(elementCount) || elementCount < minCount || elementCount > maxCount) {
            // Zeige den "kleinen Fehler"
            alert(`Ungültige Elementanzahl. Die Anzahl muss zwischen ${minCount} und ${maxCount} liegen. Setze auf 100 zurück.`);

            // Setze auf den Wert 100 zurück
            elementCount = 100;

            // Aktualisiere das Feld, damit der User die Korrektur sieht
            countInput.value = 100;
        }

        try {
            // Verwende die validierte 'elementCount' für den API-Aufruf
            const res = await fetch(`/api/compare/datasets?count=${elementCount}`);

            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const data = await res.json();
            datasets = data || {};

            const sel = document.getElementById('datasetSelect');
            sel.innerHTML = '';

            for (const key of Object.keys(datasets)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key
                    .replace(/([A-Z])/g, ' $1')
                    .replace(/^./, str => str.toUpperCase());
                sel.appendChild(opt);
            }

            if (sel.options.length > 0) sel.selectedIndex = 0;
        } catch (err) {
            console.error("Fehler beim Laden der Datensätze:", err);
        }
    }

    // --- 3️⃣ Vergleich ausführen ---
    async function compare() {
        const status = document.getElementById('status');
        status.style.display = 'inline';
        status.textContent = "Sortiere Daten...";

        try {
            const datasetKey = document.getElementById('datasetSelect').value;

            // --- START DER JAVASCRIPT-ÄNDERUNG (Validierung für Speed) ---

            // NEU: Visualisierungs-Geschwindigkeit auslesen und validieren
            const speedInput = document.getElementById('vizSpeed');
            let vizSpeed = parseInt(speedInput.value, 10);

            const minSpeed = 0;
            const maxSpeed = 1000;

            if (isNaN(vizSpeed) || vizSpeed < minSpeed || vizSpeed > maxSpeed) {
                alert(`Ungültige Pausenzeit. Die Zeit muss zwischen ${minSpeed}ms und ${maxSpeed}ms liegen. Setze auf 1ms zurück.`);
                vizSpeed = 0; // Standard-Fallback
                speedInput.value = 0;
            }

            // --- ENDE DER JAVASCRIPT-ÄNDERUNG ---

            const inputData = datasets[datasetKey];

            if (!inputData) {
                alert("Fehler: Kein Datensatz ausgewählt!");
                return;
            }

            const payload = {
                algorithms: [
                    document.getElementById('algoA').value,
                    document.getElementById('algoB').value
                ],
                input: inputData
            };

            const res = await fetch('/api/compare', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(`Fehler beim Vergleich: ${res.status} ${res.statusText}`);

            const data = await res.json();
            const table = document.getElementById('resultTable');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.algorithm ?? '-'}</td>
                    <td>${row.durationMillis ?? '-'}</td>
                    <td>${row.steps ?? '-'}</td>
                    <td>${(row.unsorted || []).join(', ')}</td>
                    <td>${(row.sorted || []).join(', ')}</td>
                    <td>${row.worstCase ?? '-'}</td>
                    <td>${row.averageCase ?? '-'}</td>
                    <td>${row.bestCase ?? '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            table.style.display = (data && data.length) ? 'table' : 'none';

            const algoA = document.getElementById('algoA').value;
            const algoB = document.getElementById('algoB').value;
            const frameA = document.getElementById('frameA');
            const frameB = document.getElementById('frameB');

            // Iframe URLs mit allen Parametern (verwendet die validierte 'vizSpeed' Variable)
            frameA.src = `/visualizer.html?algo=${encodeURIComponent(algoA)}&dataset=${encodeURIComponent(datasetKey)}&speed=${vizSpeed}`;
            frameB.src = `/visualizer.html?algo=${encodeURIComponent(algoB)}&dataset=${encodeURIComponent(datasetKey)}&speed=${vizSpeed}`;

        } catch (err) {
            console.error("Fehler beim Vergleich:", err);
            alert("Fehler beim Vergleich: " + (err.message || err));
        } finally {
            status.style.display = 'none';
        }
    }

    // --- Event-Listener und Initialisierung ---
    document.getElementById('compareBtn').addEventListener('click', compare);

    document.getElementById('elementCount').addEventListener('change', loadDatasets);

    // --- START DER JAVASCRIPT-ÄNDERUNG (Listener entfernt) ---
    // Der Event-Listener für den Slider ('input') wird nicht mehr benötigt.
    // document.getElementById('vizSpeed').addEventListener('input', ...); // <- Diese Zeile wurde entfernt
    // --- ENDE DER JAVASCRIPT-ÄNDERUNG ---

    // Initiales Laden
    loadAlgorithms();
    loadDatasets();
</script>
</body>
</html>